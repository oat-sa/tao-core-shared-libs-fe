CKEDITOR.plugins.add("taofurigana",{lang:"en",init:function(e){function t(a){a=a.getRanges()[0].extractContents().$;return new CKEDITOR.dom.element(a)}function n(a){return a.nodeType===window.Node.TEXT_NODE?a.parentNode:a}function l(a){return null!==a.getAscendant("ruby")}function p(a){var b=a.getSelection();a=b.getNative();var c;if(c=null!==a)c=!(b&&b.isCollapsed())&&b.getRanges()[0]&&!l(b.getRanges()[0].startContainer);if(b=c)if(a=!a.isCollapsed&&a.getRangeAt(0)){k=!1;var b=a.cloneContents().childNodes,
d;for(d=0;d<b.length;d++)if(c=b[d],!k&&c.nodeType!==window.Node.TEXT_NODE){k=!0;break}if(b=""!==a.toString().trim())b=n(a.startContainer),a=n(a.endContainer),b=b.isSameNode(a);b=b&&!k}else b=!1;return b}function q(a,b,c){a=a.getAscendant("ruby");var d=a.find("rb"),f=a.find("rt");if(d.$.length&&!f.$.length||b&&d.$.length&&f.$.length&&!f.$[0].innerText.trim())return e.fire("saveSnapshot"),e.fire("lockSnapshot"),rbHtml=new CKEDITOR.dom.element.createFromHtml(d.$[0].innerHTML),rbHtml.replace(a),b||(b=
new CKEDITOR.dom.range(e.document),b.selectNodeContents(rbHtml),c.selectRanges([b])),e.fire("unlockSnapshot"),!0}function h(a){function b(b){m.forEach(function(c){a.getCommand(c).setState(b)});r.forEach(function(a){a.setState(b)})}var c=a.getCommand("rubyFurigana"),d=a.getSelection(),f=d.getRanges()[0];m.length||a.toolbar.forEach(function(a){a.items&&a.items.length&&a.items.forEach(function(a){a.command&&"rubyFurigana"!==a.command?m.push(a.command):a.command||"undefined"===typeof a.setState||r.push(a)})});
c&&(p(a)?(c.setState(CKEDITOR.TRISTATE_OFF),b(CKEDITOR.TRISTATE_OFF)):d.getRanges()[0]&&l(f.startContainer)?q(f.startContainer,!1,d)?(c.setState(CKEDITOR.TRISTATE_DISABLED),b(CKEDITOR.TRISTATE_OFF)):(c.setState(CKEDITOR.TRISTATE_ON),setTimeout(function(){b(CKEDITOR.TRISTATE_DISABLED)},150)):(c.setState(CKEDITOR.TRISTATE_DISABLED),b(CKEDITOR.TRISTATE_OFF)))}var k,m=[],r=[];e.addCommand("rubyFurigana",{exec:function(a){var b=a.getSelection(),c=b.getRanges()[0],d=c.startContainer,f,e,g;l(d)?(f=d.getAscendant("ruby"),
e=f.find("rb"),g=f.find("rt"),q(d,!0)?h(a):e.$.length&&g.$.length&&d.getParent().$===g.$[0]&&null===d.$.nextSibling&&c.endOffset+1>=d.$.length&&(c=new CKEDITOR.dom.range(a.document),f.$.nextSibling?(d=new CKEDITOR.dom.text(CKEDITOR.dom.selection.FILLING_CHAR_SEQUENCE),d.insertAfter(f),c.moveToElementEditablePosition(d)):c.moveToClosestEditablePosition(f,!0),b.selectRanges([c]),h(a))):p(a)&&(a.fire("saveSnapshot"),a.fire("lockSnapshot"),f=new CKEDITOR.dom.element("ruby",a.document),e=new CKEDITOR.dom.element("rb",
a.document),e.append(t(b)),g=new CKEDITOR.dom.element("rt",a.document),brElement=new CKEDITOR.dom.element("br",a.document),g.appendHtml("\x26nbsp;"),f.append(e),f.append(g),anchor=new CKEDITOR.dom.element("span",a.document),g.append(anchor),g.appendHtml("\x26nbsp;"),g.append(brElement),a.insertElement(f),c=new CKEDITOR.dom.range(a.document),c.setStart(anchor,0),c.collapse(!0),a.getSelection().removeAllRanges(),a.getSelection().selectRanges([c]),h(a),a.fire("unlockSnapshot"),anchor.remove())}});e.on("instanceReady",
function(){var a=e.editable();e.getCommand("rubyFurigana").setState(CKEDITOR.TRISTATE_DISABLED);a.attachListener(a,"mouseup",function(){h(e)});a.attachListener(a,"keyup",function(){h(e)})});e.ui.addButton("TaoFurigana",{label:e.lang.rubyFurigana.button,command:"rubyFurigana",icon:this.path+"images/taofurigana.png"})}});