CKEDITOR.plugins.add("taotooltip",{lang:"de,en,fr,ja,nl",init:function(d){function g(a){a=a.getSelection();var b=a.getNative(),c;if(c=null!==b)if(c=b.getRangeAt(0),!(c=b&&b.isCollapsed&&!h(b.getRangeAt(c.startContainer))))if(b=!b.isCollapsed&&b.getRangeAt(0)){f=!1;k(b.cloneContents());if(c=""!==b.toString().trim()){c=l(b.startContainer);var d=l(b.endContainer);c=c.isSameNode(d)}c=c&&!f&&!h(b.startContainer)}else c=!1;if(b=c)b=null===a.getRanges()[0].startContainer.getAscendant("ruby");return b}function k(a){a=
a.childNodes;var b,c;for(c=0;c<a.length;c++)if(b=a[c],!f&&b.nodeType===window.Node.ELEMENT_NODE){var d=b.nodeName&&b.nodeName.toLowerCase();-1===n.indexOf(d)?f=!0:k(b)}}function l(a){return a.nodeType===window.Node.TEXT_NODE?a.parentNode:a}function h(a){return(new CKEDITOR.dom.element(a)).getAscendant(function(a){return a.$&&a.$.dataset&&"_tooltip"===a.$.dataset.qtiClass})}function p(a){a=a.getRanges()[0].extractContents().$;return new CKEDITOR.dom.element(a)}function m(a){var b=a.getCommand("insertTaoTooltip");
b&&(g(a)?b.setState(CKEDITOR.TRISTATE_OFF):b.setState(CKEDITOR.TRISTATE_DISABLED))}var n="b strong i em s sub sup u".split(" "),f;d.addCommand("insertTaoTooltip",{exec:function(a){var b=a.config.taoQtiItem,c=a.getSelection(),d=c.getNative(),e;g(a)&&"function"===typeof b.insert&&(e=new CKEDITOR.dom.element("span",a.document),e.setAttributes({"data-new":!0,"data-qti-class":"_tooltip","class":"widget-box"}),d&&d.isCollapsed?e.appendHtml("\x26nbsp;"):e.append(p(c)),a.insertElement(e),b.insert.call(a,
e.$))}});d.on("instanceReady",function(){var a=d.editable();a.attachListener(a,"mouseup",function(){m(d)});a.attachListener(a,"keyup",function(){m(d)})});d.ui.addButton("TaoTooltip",{label:d.lang.insertTaoTooltip.button,command:"insertTaoTooltip",icon:this.path+"images/taotooltip.png"})}});